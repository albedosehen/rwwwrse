# Apache HTTP Server Configuration for rwwwrse Reverse Proxy Chaining
# This configuration sets up Apache as a front-end proxy to rwwwrse
# Provides SSL termination, caching, rate limiting, and security features

# Basic server configuration
ServerRoot "/etc/httpd"
Listen 80
Listen 443 ssl http2

# Modules - ensure these are loaded
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule headers_module modules/mod_headers.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so
LoadModule cache_module modules/mod_cache.so
LoadModule cache_disk_module modules/mod_cache_disk.so
LoadModule status_module modules/mod_status.so
LoadModule info_module modules/mod_info.so
LoadModule remoteip_module modules/mod_remoteip.so
LoadModule security2_module modules/mod_security2.so
LoadModule evasive24_module modules/mod_evasive24.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule setenvif_module modules/mod_setenvif.so

# Basic configuration
ServerAdmin admin@example.com
ServerName proxy.example.com
DirectoryIndex index.html

# Security settings
ServerTokens Prod
ServerSignature Off
TraceEnable Off

# Performance settings - MPM Event configuration
<IfModule mod_mpm_event.c>
    StartServers             3
    MinSpareThreads         75
    MaxSpareThreads        250
    ThreadsPerChild         25
    MaxRequestWorkers      400
    MaxConnectionsPerChild   0
    ThreadLimit             64
    ServerLimit             16
</IfModule>

# Timeout settings
Timeout 60
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# MIME types
<IfModule mod_mime.c>
    TypesConfig /etc/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml
</IfModule>

# Logging configuration
ErrorLog /var/log/httpd/error_log
LogLevel warn

# Custom log format for JSON logging
LogFormat "{ \"time\": \"%{%Y-%m-%dT%H:%M:%S}t.%{msec_frac}t%{%z}t\", \"remoteaddr\": \"%a\", \"host\": \"%V\", \"request\": \"%r\", \"status\": \"%>s\", \"size\": \"%B\", \"referer\": \"%{Referer}i\", \"useragent\": \"%{User-Agent}i\", \"requesttime\": \"%D\", \"x_forwarded_for\": \"%{X-Forwarded-For}i\", \"x_request_id\": \"%{X-Request-ID}o\" }" json_combined

# Standard combined log format
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %O" common

# Access log
CustomLog /var/log/httpd/access_log json_combined

# Security headers (global)
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;"

# Hide server information
Header always unset Server
Header always set Server "rwwwrse-apache"

# Real IP configuration
<IfModule mod_remoteip.c>
    RemoteIPHeader X-Forwarded-For
    RemoteIPInternalProxy 10.0.0.0/8
    RemoteIPInternalProxy 172.16.0.0/12
    RemoteIPInternalProxy 192.168.0.0/16
    RemoteIPInternalProxy 127.0.0.1
</IfModule>

# Security module configuration
<IfModule mod_security2.c>
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess On
    SecResponseBodyMimeType text/plain text/html text/xml application/json
    SecDataDir /tmp
    SecUploadDir /tmp
    SecUploadKeepFiles Off
    SecUploadFileLimit 100
    SecRequestBodyLimit 13107200
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyInMemoryLimit 131072
    SecRequestBodyLimitAction Reject
    SecPcreMatchLimit 1000
    SecPcreMatchLimitRecursion 1000
    
    # Basic rules
    SecRule REQUEST_HEADERS:Content-Type "text/xml" \
        "id:'200000',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"
    SecRule REQUEST_HEADERS:Content-Type "application/xml" \
        "id:'200001',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"
    SecRule REQUEST_HEADERS:Content-Type "text/json" \
        "id:'200002',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"
    SecRule REQUEST_HEADERS:Content-Type "application/json" \
        "id:'200003',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"
</IfModule>

# DDoS protection with mod_evasive
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        2
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    DOSLogDir           /var/log/httpd/dos
    DOSEmailNotify      admin@example.com
    DOSWhitelist        127.0.0.1
    DOSWhitelist        10.*
    DOSWhitelist        172.16.*
    DOSWhitelist        192.168.*
</IfModule>

# SSL Configuration
<IfModule mod_ssl.c>
    SSLRandomSeed startup builtin
    SSLRandomSeed connect builtin
    
    # Modern SSL configuration
    SSLProtocol TLSv1.2 TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder Off
    SSLSessionCache shmcb:/var/cache/mod_ssl/scache(512000)
    SSLSessionCacheTimeout 300
    SSLUseStapling On
    SSLStaplingCache shmcb:/var/cache/mod_ssl/stapling(32768)
    
    # Disable SSL compression
    SSLCompression Off
    
    # OCSP Stapling
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors Off
</IfModule>

# Cache configuration
<IfModule mod_cache.c>
    CacheRoot /var/cache/httpd/cache
    CacheEnable disk /
    CacheDirLevels 2
    CacheDirLength 1
    CacheMaxFileSize 1000000
    CacheMinFileSize 1
    CacheDefaultExpire 3600
    CacheMaxExpire 86400
    CacheIgnoreCacheControl On
    CacheIgnoreNoLastMod On
    
    # Don't cache certain content
    CacheDisable /api/auth/
    CacheDisable /admin/
    CacheDisable /metrics
    CacheDisable /health
</IfModule>

# Proxy configuration for rwwwrse backend
<Proxy balancer://rwwwrse-cluster>
    BalancerMember http://127.0.0.1:8080 route=1 retry=300
    BalancerMember http://127.0.0.1:8081 route=2 retry=300 status=+H
    ProxySet connectiontimeout=30
    ProxySet retry=300
    ProxySet timeout=60
</Proxy>

# Proxy settings
<IfModule mod_proxy.c>
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyTimeout 60
    ProxyBadHeader Ignore
    
    # Connection pooling
    ProxyIOBufferSize 65536
    
    # Proxy status handler
    <Location "/balancer-manager">
        SetHandler balancer-manager
        Require ip 127.0.0.1
        Require ip 10.0.0.0/8
        Require ip 172.16.0.0/12
        Require ip 192.168.0.0/16
    </Location>
</IfModule>

# Directory permissions
<Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all denied
</Directory>

<Directory "/var/www">
    AllowOverride None
    Require all granted
</Directory>

<Directory "/var/www/html">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Default catch-all virtual host
<VirtualHost *:80>
    ServerName _
    DocumentRoot /var/www/html/default
    
    # Return 444 for unknown hosts
    RewriteEngine On
    RewriteRule .* - [R=444,L]
</VirtualHost>

# HTTP to HTTPS redirect for known hosts
<VirtualHost *:80>
    ServerName api.example.com
    ServerAlias app.example.com web.example.com admin.example.com
    
    # ACME challenge for Let's Encrypt
    Alias /.well-known/acme-challenge/ /var/www/letsencrypt/.well-known/acme-challenge/
    <Directory "/var/www/letsencrypt/.well-known/acme-challenge/">
        Require all granted
    </Directory>
    
    # Redirect all other traffic to HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

# API Server (HTTPS)
<VirtualHost *:443>
    ServerName api.example.com
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/api.example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/api.example.com/privkey.pem
    
    # Enhanced security headers for API
    Header always set X-API-Version "1.0"
    Header always set Cache-Control "no-cache, no-store, must-revalidate"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
    
    # Rate limiting using mod_evasive (applied per virtual host)
    <Location />
        DOSPageCount 10
        DOSSiteCount 100
        DOSPageInterval 1
        DOSSiteInterval 1
        DOSBlockingPeriod 600
    </Location>
    
    # Proxy to rwwwrse backend
    ProxyPreserveHost On
    ProxyPass /balancer-manager !
    ProxyPass / balancer://rwwwrse-cluster/
    ProxyPassReverse / balancer://rwwwrse-cluster/
    
    # Set proxy headers
    ProxyPassReverse / balancer://rwwwrse-cluster/
    ProxySetHeader Host %{HTTP_HOST}
    ProxySetHeader X-Real-IP %{REMOTE_ADDR}
    ProxySetHeader X-Forwarded-For %{REMOTE_ADDR}
    ProxySetHeader X-Forwarded-Proto https
    ProxySetHeader X-Forwarded-Host %{HTTP_HOST}
    ProxySetHeader X-Forwarded-Port 443
    
    # Disable caching for API
    <LocationMatch "^/api/">
        CacheDisable on
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
    </LocationMatch>
    
    # Health check endpoint (enable caching)
    <Location "/health">
        CacheEnable disk
        CacheDefaultExpire 30
        ExpiresActive On
        ExpiresDefault "access plus 30 seconds"
    </Location>
    
    # Metrics endpoint (internal access only)
    <Location "/metrics">
        Require ip 127.0.0.1
        Require ip 10.0.0.0/8
        Require ip 172.16.0.0/12
        Require ip 192.168.0.0/16
    </Location>
    
    # Custom error pages
    ErrorDocument 502 /errors/502.html
    ErrorDocument 503 /errors/503.html
    ErrorDocument 504 /errors/504.html
</VirtualHost>

# Frontend Application Server (HTTPS)
<VirtualHost *:443>
    ServerName app.example.com
    DocumentRoot /var/www/app.example.com
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/app.example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/app.example.com/privkey.pem
    
    # Static file serving with caching
    <LocationMatch "\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header append Cache-Control "public, immutable"
        Header append Vary "Accept-Encoding"
        
        # Try local files first
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule .* - [E=PROXY_BACKEND:1]
    </LocationMatch>
    
    # Proxy configuration for dynamic content
    RewriteEngine On
    RewriteCond %{ENV:PROXY_BACKEND} =1 [OR]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ balancer://rwwwrse-cluster/$1 [P,L]
    
    # Proxy headers for dynamic content
    ProxyPreserveHost On
    ProxySetHeader Host %{HTTP_HOST}
    ProxySetHeader X-Real-IP %{REMOTE_ADDR}
    ProxySetHeader X-Forwarded-For %{REMOTE_ADDR}
    ProxySetHeader X-Forwarded-Proto https
    ProxySetHeader X-Request-ID %{UNIQUE_ID}
    
    # Enable caching for frontend
    CacheEnable disk /
    CacheDefaultExpire 300
    
    # Cache control headers
    <LocationMatch "^(?!/api/)">
        Header always append X-Cache-Status "HIT from Apache"
    </LocationMatch>
</VirtualHost>

# Web Service Server (HTTPS)
<VirtualHost *:443>
    ServerName web.example.com
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/web.example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/web.example.com/privkey.pem
    
    # Standard rate limiting
    <Location />
        DOSPageCount 5
        DOSSiteCount 50
        DOSPageInterval 1
        DOSSiteInterval 1
        DOSBlockingPeriod 300
    </Location>
    
    # Proxy to rwwwrse
    ProxyPreserveHost On
    ProxyPass / balancer://rwwwrse-cluster/
    ProxyPassReverse / balancer://rwwwrse-cluster/
    
    # Proxy headers
    ProxySetHeader Host %{HTTP_HOST}
    ProxySetHeader X-Real-IP %{REMOTE_ADDR}
    ProxySetHeader X-Forwarded-For %{REMOTE_ADDR}
    ProxySetHeader X-Forwarded-Proto https
    ProxySetHeader X-Request-ID %{UNIQUE_ID}
    
    # Enable caching
    CacheEnable disk /
    CacheDefaultExpire 600
    
    # Performance headers
    Header always append X-Cache-Status "%{cache-status}e"
</VirtualHost>

# Admin Interface (HTTPS with additional security)
<VirtualHost *:443>
    ServerName admin.example.com
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/admin.example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/admin.example.com/privkey.pem
    
    # Enhanced security headers for admin
    Header always set X-Frame-Options "DENY"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';"
    
    # Strict rate limiting for admin interface
    <Location />
        DOSPageCount 2
        DOSSiteCount 20
        DOSPageInterval 1
        DOSSiteInterval 1
        DOSBlockingPeriod 1200
    </Location>
    
    # IP whitelisting (uncomment and configure as needed)
    # <RequireAll>
    #     Require ip 203.0.113.0/24
    #     Require ip 198.51.100.0/24
    # </RequireAll>
    
    # Proxy to rwwwrse
    ProxyPreserveHost On
    ProxyPass / balancer://rwwwrse-cluster/
    ProxyPassReverse / balancer://rwwwrse-cluster/
    
    # Proxy headers
    ProxySetHeader Host %{HTTP_HOST}
    ProxySetHeader X-Real-IP %{REMOTE_ADDR}
    ProxySetHeader X-Forwarded-For %{REMOTE_ADDR}
    ProxySetHeader X-Forwarded-Proto https
    ProxySetHeader X-Request-ID %{UNIQUE_ID}
    
    # Disable caching for admin interface
    CacheDisable /
    Header always set Cache-Control "no-cache, no-store, must-revalidate"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
    
    # Increase timeouts for admin operations
    ProxyTimeout 120
</VirtualHost>

# Status and monitoring (internal access)
<VirtualHost 127.0.0.1:8888>
    ServerName localhost
    
    # Apache status
    <Location "/server-status">
        SetHandler server-status
        Require ip 127.0.0.1
    </Location>
    
    # Apache info
    <Location "/server-info">
        SetHandler server-info
        Require ip 127.0.0.1
    </Location>
    
    # Health check endpoint
    <Location "/health">
        SetHandler server-status
        Require all granted
    </Location>
    
    # Proxy balancer status
    <Location "/balancer-info">
        SetHandler balancer-manager
        Require ip 127.0.0.1
    </Location>
</VirtualHost>

# Include additional configurations
IncludeOptional conf.d/*.conf